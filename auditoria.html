<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Auditoria • CLENA</title>

<meta name="viewport"
  content="width=device-width,
  initial-scale=1,
  maximum-scale=1,
  user-scalable=no,
  viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
:root{
  --bg:#040507;
  --card:#0b1220;
  --border:#0f172a;
  --neon:#00e5ff;
  --ok:#22c55e;
  --warn:#facc15;
  --danger:#ef4444;
  --text:#fff;
  --muted:#9ca3af;
}

*{
  box-sizing:border-box;
  font-family:Inter;
  touch-action:manipulation;
}

html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

/* LAYOUT */
.container{
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}

/* CARD */
.card{
  background:linear-gradient(180deg,#0b1220,#060a14);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  display:flex;
  gap:12px;
}

/* IMAGEM */
.thumb{
  width:72px;
  height:72px;
  border-radius:14px;
  background:#020409;
  border:1px solid var(--border);
  background-size:cover;
  background-position:center;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--muted);
  font-size:10px;
}

/* CONTEÚDO */
.content{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:6px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.header strong{
  font-size:13px;
}

/* BADGES */
.badge{
  font-size:10px;
  padding:4px 8px;
  border-radius:999px;
  font-weight:800;
}
.ok{background:rgba(34,197,94,.15);color:#4ade80}
.warn{background:rgba(250,204,21,.15);color:#fde047}
.danger{background:rgba(239,68,68,.15);color:#f87171}

/* INFO */
.info{
  font-size:11px;
  color:var(--muted);
  line-height:1.45;
}

/* ACTIONS */
.actions{
  display:flex;
  gap:8px;
  margin-top:6px;
}
.btn{
  flex:1;
  border:none;
  border-radius:999px;
  padding:8px;
  font-size:11px;
  font-weight:800;
  cursor:pointer;
}
.btn-wa{background:#22c55e;color:#000}
.btn-del{background:#ef4444;color:#fff}
</style>
</head>

<body>

<div class="container" id="lista"></div>

<script>
const sb = supabase.createClient(
  "https://egxjgmzukjyyxmkukwub.supabase.co",
  "sb_publishable_EWwdrLOUk6KDHZGLuh4uRg_QDRtLeFi"
);

async function carregar(){
  const { data: produtos } = await sb
    .from("produtos_servicos")
    .select("*")
    .order("created_at",{ ascending:false });

  const { data: lojas } = await sb
    .from("user_profile")
    .select("user_id,negocio,whatsapp,cidade,uf,responsavel");

  const mapLojas = {};
  lojas.forEach(l=>mapLojas[l.user_id]=l);

  lista.innerHTML = produtos.map(p=>{
    const loja = mapLojas[p.user_id] || {};
    const wa = loja.whatsapp
      ? `<button class="btn btn-wa" onclick="wa('${loja.whatsapp}')">WhatsApp</button>`
      : "";

    const img = p.imagem_url
      ? `<div class="thumb" style="background-image:url('${p.imagem_url}')"></div>`
      : `<div class="thumb">SEM FOTO</div>`;

    return `
      <div class="card">

        ${img}

        <div class="content">

          <div class="header">
            <strong>${p.nome}</strong>
            <span class="badge ${p.ativo?"ok":"danger"}">
              ${p.ativo?"Ativo":"Inativo"}
            </span>
          </div>

          <div class="info">
            ${p.tipo} • R$ ${Number(p.preco).toFixed(2)}<br>
            Loja: ${loja.negocio||"-"}<br>
            ${loja.cidade||""} ${loja.uf||""}<br>
            Resp: ${loja.responsavel||"-"}
          </div>

          <div class="actions">
            ${wa}
            <button class="btn btn-del" onclick="excluir('${p.id}')">
              Excluir
            </button>
          </div>

        </div>
      </div>
    `;
  }).join("");
}

function wa(num){
  const n = num.replace(/\D/g,"");
  window.open(`https://wa.me/55${n}`,"_blank");
}

async function excluir(id){
  if(!confirm("Excluir este produto permanentemente?")) return;

  const res = await fetch("/api/admin-delete-produto.js",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ produto_id:id })
  });

  const data = await res.json();
  if(!res.ok){
    alert(data.error||"Erro");
    return;
  }

  carregar();
}

/* Atualização silenciosa */
window.addEventListener("message",e=>{
  if(e.data?.type==="REFRESH") carregar();
});

carregar();
</script>

</body>
</html>
